import { MeshValue, TxInParameter, TxParser } from "@meshsdk/core";
import { blockfrost } from "./utils";
import { CSLSerializer } from "@meshsdk/core-csl";

const txHex =
  "84ab00d90102858258200f028b3fdf972d4fa49643c51b391d2dcbd8405050c0d632feb5917662afc16c02825820144503a673d9730cf6c94b86d7587985114dc95f3386502404ba7b39c00c26000382582066bd3da1eda52d18a28e50b39a4197c38d745da44e80a7b0ec51519c8a9e5eca0082582069ddd4125f7e42842eb5ab2cf6ddfb4586361ec9d8458ea2b1ea86f1041bec850082582069ddd4125f7e42842eb5ab2cf6ddfb4586361ec9d8458ea2b1ea86f1041bec85020184a300581d70e363b9f9bb8b623624e3b1eba00e281d493bf05536830e029413050d01821a004c4b42a1581c4d650bdfd6b607ba74bd79e898c16b0ab887506a595372e2690dcd6aa14001028201d8185826d8799f5820718719705040dc07e3ad7ce3cfa888e4bd18e48590cdaead97bb2669f5bb4f01ff82583900553abf193cc677538b3b8a87764afa87000e275b2eb738216d73a435e585ce32db2913d00a002c2137e20efb8a964d435cbdd182b67036be821a009fb2cfa5581c3363b99384d6ee4c4b009068af396c8fdf92dafd111e58a857af0429a1454e494748541a00989680581c378f9732c755ed6f4fc8d406f1461d0cca95d7d2e69416784684df39a144534e454b0a581c82e46eb16633bf8bfa820c83ffeb63192c6e21757d2bf91290b2f41da1434941471a00a037a0581ca2818ba06a88bb6c08d10f4f9b897c09768f28d274093628ad7086fca145484f534b590a581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a009f1d7082581d709a05f2ee9a1acac016269334d7866eea9eb8ef9b436edde8943b8cf3821a004c5b40a4581c3363b99384d6ee4c4b009068af396c8fdf92dafd111e58a857af0429a1454e494748541a02625a00581c378f9732c755ed6f4fc8d406f1461d0cca95d7d2e69416784684df39a144534e454b1828581ca2818ba06a88bb6c08d10f4f9b897c09768f28d274093628ad7086fca145484f534b591828581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a008856808258390008d9d743d6ee8cbec90836b8eb7a0563698a0d2a3b154cbad9ca13467c16240714ea0e12b41a914f2945784ac494bb19573f0ca61a08afa8821b0000000ba18d4380a5581c3363b99384d6ee4c4b009068af396c8fdf92dafd111e58a857af0429a1454e494748541b00005af3107a4000581c378f9732c755ed6f4fc8d406f1461d0cca95d7d2e69416784684df39a144534e454b1b000000e8d4a51000581c82e46eb16633bf8bfa820c83ffeb63192c6e21757d2bf91290b2f41da1434941471b00005af310002e00581ca2818ba06a88bb6c08d10f4f9b897c09768f28d274093628ad7086fca145484f534b591a000f4240581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1b000000e8d4a51000021bffffffffffffffff05a1581df0b0c13a4feccc8e93e424f743f79ac0269641a8439ef921690dac9fd900075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030c0b5820ac2428f929f1b2ba3ae26fb9b1c53a01dd2ebb445971462ad6c36c656d7dcfcb0dd901028182582028e9a2e5a8dff6d1500574dabf5ebcc83812c260e4b16e53284d617928091c0a000ed9010281581c672dabb562df94a2c363a8fb175225a333bb3225ebe0273b9b7a539c1082583900672dabb562df94a2c363a8fb175225a333bb3225ebe0273b9b7a539cfa1d2da9a7c2400dbd70c38a55239d51dde8727e745ea97fc265b09a1a006acfc0111a002dc6c012d901028482582047a5363b7a14fe6a18bdf3fceb283d26c4d56a3884778e2016740b3ec476420a00825820368d40cfe569cdf957546a81f8fb5a86942bdd9ce2dc8731abb445dd096d28ca008258208866f19f96f588612690b2ba51bea9f9cca385bb14df4ff5cdf4798c654d6e7a00825820029491464b2cdb61920811b80b328a28f3d5b6ba4d8cb4261416d072712cf80f00a105a582000082d87980821a006acfc01ab2d05e0082000282d87980821a006acfc01ab2d05e0082000382d87a80821a006acfc01ab2d05e0082000482d87980821a006acfc01ab2d05e0082030082d8799fd8799fd8799f507d9424147acd42f398fd0b1c6504ca2cd8799f581c553abf193cc677538b3b8a87764afa87000e275b2eb738216d73a435ffd8799f581cb21f857716821354725bc2bd255dc2e5d5fdfa202556039b76c080a5ffff581cfb909b29e5f4ec2910707d7a5cf5dae3039c45d25c9843e5e3556a94ffa640a1401a009fb2cf581c3363b99384d6ee4c4b009068af396c8fdf92dafd111e58a857af0429a1454e494748541a00989680581c378f9732c755ed6f4fc8d406f1461d0cca95d7d2e69416784684df39a144534e454b0a581c82e46eb16633bf8bfa820c83ffeb63192c6e21757d2bf91290b2f41da1434941471a00a037a0581ca2818ba06a88bb6c08d10f4f9b897c09768f28d274093628ad7086fca145484f534b590a581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a009f1d70d87b9f9fd8799f005f58400e15e783c17b7007285362e5aca614a9cf5b056b5dc31b2dc7abeae9aacb601085c09af929492a871e4fae32d9d5c36e352471cd659bcdb61de08f1722acc3b158409f078c040980261d3c57fec9dabb9f1d714b2e244b45a4973654632a259200790000000000000000000000000000000000000000000000000000000000000000ffffd87b9f005820084eb6043b188c83cb29eade44f0385d737d23a8d130c12205b06f17e09864ba58201b1f8ae18dad0486a61087c5105889d9290d0f77cc5a68447a366ee48d53fff6ffffffff821a006acfc01ab2d05e00f5d90103a0";

const main = async () => {
  const serializer = new CSLSerializer();
  const txParser = new TxParser(serializer, blockfrost);
  const parsedTx = await txParser.parse(txHex);

  const vaultAddress =
    "addr_test1wzdqtuhwngdv4sqky6fnf4uxdm4faw80ndpkah0gjsaceuc0exzkf";
  const userAddress =
    "addr_test1qp2n40ce8nr8w5ut8w9gwaj2l2rsqr38tvhtwwppd4e6gd09sh8r9kefz0gq5qpvyym7yrhm32ty6s6uhhgc9dnsx6lqxwxsme";

  const vaultInputs: TxInParameter[] = [];
  const vaultInputValue = new MeshValue();
  const vaultOutputValue = new MeshValue();
  const userOutputValue = new MeshValue();
  parsedTx.inputs.forEach((txIn) => {
    if (txIn.txIn.address === vaultAddress) {
      vaultInputs.push(txIn.txIn);
      vaultInputValue.addAssets(txIn.txIn.amount || []);
    }
  });
  parsedTx.outputs.forEach((txOut) => {
    if (txOut.address === vaultAddress) {
      vaultOutputValue.addAssets(txOut.amount || []);
    }
    if (txOut.address === userAddress) {
      userOutputValue.addAssets(txOut.amount || []);
    }
  });

  console.log("Vault input value", vaultInputValue.toAssets());
  console.log("Vault output value", vaultOutputValue.toAssets());
  console.log(
    "Vault EQ:",
    vaultInputValue.geq(vaultOutputValue),
    vaultOutputValue.geq(vaultInputValue)
  );

  const vaultNewValue = vaultInputValue.negateAssets(
    vaultOutputValue.toAssets()
  );

  console.log("Vault new value", vaultNewValue.toAssets());
  console.log("User output value", userOutputValue.toAssets());

  console.log(
    "EQ",
    vaultNewValue.geq(userOutputValue),
    userOutputValue.geq(vaultNewValue)
  );

  console.log("Vault inputs:", JSON.stringify(vaultInputs, null, 2));
};

main();
